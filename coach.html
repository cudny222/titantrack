<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coach - TitanTrack</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #0a0e27 url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=1920&q=80') center/cover fixed;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.92) 0%, rgba(26, 31, 58, 0.88) 50%, rgba(15, 20, 25, 0.95) 100%);
            z-index: 0;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            color: #4A9EFF;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(74, 158, 255, 0.5), 0 0 40px rgba(74, 158, 255, 0.2);
        }
        
        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4A9EFF 0%, #2962FF 100%);
            color: #FFFFFF;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
            background: linear-gradient(135deg, #5AA9FF 0%, #3972FF 100%);
        }
        
        .card {
            background: rgba(15, 20, 35, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(74, 158, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .chat-container {
            height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(10, 14, 39, 0.4);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 10px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .message.user {
            background: linear-gradient(135deg, #4A9EFF 0%, #2962FF 100%);
            color: #FFFFFF;
            margin-left: auto;
            text-align: right;
        }
        
        .message.ai {
            background: rgba(74, 158, 255, 0.15);
            border: 1px solid rgba(74, 158, 255, 0.3);
            color: #E8EAED;
        }
        
        .message-label {
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 5px;
            color: #8AB4F8;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
        }
        
        textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            background: rgba(10, 14, 39, 0.6);
            color: #E8EAED;
            font-size: 15px;
            font-weight: 500;
            resize: vertical;
            min-height: 60px;
            font-family: Arial, sans-serif;
            transition: all 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4A9EFF;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
            background: rgba(10, 14, 39, 0.8);
        }
        
        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #4A9EFF 0%, #2962FF 100%);
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
            background: linear-gradient(135deg, #5AA9FF 0%, #3972FF 100%);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-summary {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #E8EAED;
        }
        
        .stats-summary h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #4A9EFF;
            font-weight: 600;
        }
        
        .stats-summary p {
            color: #8AB4F8;
            font-weight: 500;
        }
        
        .stats-summary strong {
            color: #E8EAED;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <a href="gym_tracker.html" class="back-btn" data-en="‚Üê Back to Tracker" data-pl="‚Üê Powr√≥t do Trackera" style="margin: 0;">‚Üê Back to Tracker</a>
            <div>
                <button onclick="switchLanguage('en')" id="langEN" style="padding: 8px 15px; font-size: 14px; width: auto; margin-right: 5px;">üá¨üáß EN</button>
                <button onclick="switchLanguage('pl')" id="langPL" style="padding: 8px 15px; font-size: 14px; width: auto;">üáµüá± PL</button>
            </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="logo.png" alt="TitanTrack" style="max-width: 100%; height: auto; max-height: 220px; filter: drop-shadow(0 0 20px rgba(74, 158, 255, 0.3));">
        </div>
        <h2 style="text-align: center; color: #4A9EFF; font-size: 1.8em; font-weight: 600; margin-bottom: 20px;" data-en="ü§ñ AI Coach" data-pl="ü§ñ Trener AI">ü§ñ AI Coach</h2>
        
        <div class="card">
            <div class="stats-summary" id="statsSummary">
                <h3 data-en="Your Training Stats" data-pl="Twoje Statystyki Treningowe">Your Training Stats</h3>
                <p data-en="Loading your data..." data-pl="≈Åadowanie danych...">Loading your data...</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button onclick="resetApiKey()" style="padding: 8px 15px; font-size: 14px; width: auto;" data-en="üîë Change API Key" data-pl="üîë Zmie≈Ñ Klucz API">üîë Change API Key</button>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="message ai">
                    <div class="message-label" data-en="AI Coach (Powered by Groq)" data-pl="Trener AI (Napƒôdzany przez Groq)">AI Coach (Powered by Groq)</div>
                    <div id="welcomeMsg" data-en="Hey there, champion! üí™ I'm your AI coach powered by Groq's Llama 3.3. I can help you with training plans, exercise techniques, and personalized advice based on your workout history. What would you like to know?" data-pl="Cze≈õƒá, mistrzu! üí™ Jestem Twoim trenerem AI napƒôdzanym przez Groq's Llama 3.3. Mogƒô pom√≥c Ci z planami treningowymi, technikami ƒáwicze≈Ñ i spersonalizowanymi poradami opartymi na Twojej historii trening√≥w. Co chcia≈Çby≈õ wiedzieƒá?">Hey there, champion! üí™ I'm your AI coach powered by Groq's Llama 3.3. I can help you with training plans, exercise techniques, and personalized advice based on your workout history. What would you like to know?</div>
                </div>
            </div>
            
            <div class="input-container">
                <textarea id="userInput" data-en-placeholder="Ask me anything about training..." data-pl-placeholder="Zapytaj mnie o cokolwiek zwiƒÖzanego z treningiem..." placeholder="Ask me anything about training..."></textarea>
                <button onclick="sendMessage()" id="sendBtn" data-en="Send" data-pl="Wy≈õlij">Send</button>
            </div>
        </div>
    </div>
    
    <script>
        // Check if user is logged in (check both localStorage and sessionStorage)
        const userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
        if (!userId) {
            window.location.href = 'login.html';
        }
        
        // Load user's training data
        function loadUserStats() {
            const data = localStorage.getItem('gymData');
            if (!data) {
                document.getElementById('statsSummary').innerHTML = `
                    <h3 data-en="Your Training Stats" data-pl="Twoje Statystyki Treningowe">${currentLang === 'pl' ? 'Twoje Statystyki Treningowe' : 'Your Training Stats'}</h3>
                    <p>${t('noData')}</p>
                `;
                return null;
            }
            
            const gymData = JSON.parse(data);
            const dates = Object.keys(gymData).sort();
            const totalSessions = dates.length;
            
            let totalWeight = 0;
            const exercises = new Set();
            
            dates.forEach(date => {
                gymData[date].forEach(ex => {
                    const series = ex.series || 1;
                    totalWeight += ex.weight * ex.reps * series;
                    exercises.add(ex.exercise);
                });
            });
            
            const lastWorkout = dates.length > 0 ? dates[dates.length - 1] : t('never');
            
            document.getElementById('statsSummary').innerHTML = `
                <h3>${currentLang === 'pl' ? 'Twoje Statystyki Treningowe' : 'Your Training Stats'}</h3>
                <p><strong>${t('totalSessions')}:</strong> ${totalSessions}</p>
                <p><strong>${t('totalWeight')}:</strong> ${totalWeight.toLocaleString()} kg</p>
                <p><strong>${t('uniqueExercises')}:</strong> ${exercises.size}</p>
                <p><strong>${t('lastWorkout')}:</strong> ${lastWorkout.replace(/-/g, '.')}</p>
            `;
            
            return {
                totalSessions,
                totalWeight,
                exercises: Array.from(exercises),
                lastWorkout,
                recentWorkouts: dates.slice(-10).map(date => ({
                    date,
                    exercises: gymData[date]
                }))
            };
        }
        
        // Send message to AI
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Disable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = t('thinking');
            
            // Get user stats for context
            const stats = loadUserStats();
            
            // Create context for AI with full training data
            let systemPrompt = currentLang === 'pl' 
                ? `Jeste≈õ profesjonalnym trenerem fitness i trenerem personalnym. Udzielasz eksperckich porad dotyczƒÖcych treningu, od≈ºywiania i regeneracji. BƒÖd≈∫ zachƒôcajƒÖcy, konkretny i praktyczny. Odpowiadaj ZAWSZE po polsku.`
                : `You are a professional fitness coach and personal trainer. You provide expert advice on training, nutrition, and recovery. Be encouraging, specific, and practical.`;
            
            let userContext = '';
            if (stats) {
                userContext = `\n\nUser's Training Summary:\n- Total sessions: ${stats.totalSessions}\n- Total weight lifted: ${stats.totalWeight.toLocaleString()} kg\n- Unique exercises: ${stats.exercises.join(', ')}\n- Last workout: ${stats.lastWorkout}`;
                
                // Add detailed recent workout history
                if (stats.recentWorkouts && stats.recentWorkouts.length > 0) {
                    userContext += `\n\nRecent Training History (last ${stats.recentWorkouts.length} sessions):`;
                    stats.recentWorkouts.forEach(workout => {
                        const date = workout.date.replace(/-/g, '.');
                        userContext += `\n\n${date}:`;
                        workout.exercises.forEach(ex => {
                            const series = ex.series || 1;
                            userContext += `\n  - ${ex.exercise}: ${series} sets √ó ${ex.weight}kg √ó ${ex.reps} reps`;
                        });
                    });
                }
            }
            
            const fullPrompt = systemPrompt + userContext + `\n\nUser question: ${message}\n\nProvide a helpful, encouraging response based on their training data:`;
            
            try {
                // Get API key from localStorage
                let apiKey = localStorage.getItem('groqApiKey');
                
                if (!apiKey) {
                    const promptMsg = currentLang === 'pl' ? 'Wprowad≈∫ sw√≥j klucz API Groq:\n\nOtrzymaj go ZA DARMO z: https://console.groq.com/keys' : 'Please enter your Groq API key:\n\nGet it FREE from: https://console.groq.com/keys';
                    apiKey = prompt(promptMsg);
                    if (apiKey && apiKey.trim()) {
                        localStorage.setItem('groqApiKey', apiKey.trim());
                    } else {
                        throw new Error('No API key provided');
                    }
                }
                
                console.log('Sending request to Groq AI...');
                
                // Using Groq API (Fast & Free with Llama 3.3)
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt + userContext
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 800
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`API request failed: ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    addMessage(aiResponse, 'ai');
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('AI Error:', error);
                
                // Show error to user
                if (error.message.includes('401') || error.message.includes('API key')) {
                    addMessage('‚ùå Invalid API key. Click "Change API Key" button to enter a new one.', 'ai');
                    localStorage.removeItem('groqApiKey');
                } else {
                    addMessage(`‚ö†Ô∏è Could not connect to AI. Using offline mode.\n\n${getFallbackResponse(message, stats)}`, 'ai');
                }
            }
            
            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.textContent = t('send');
        }
        
        // Fallback responses (works without API)
        function getFallbackResponse(message, stats) {
            const msg = message.toLowerCase();
            
            if (msg.includes('training plan') || msg.includes('workout plan')) {
                return `Based on your ${stats?.totalSessions || 0} sessions, here's a solid plan:\n\n**Push Day:** Bench Press, Shoulder Press, Tricep Dips\n**Pull Day:** Deadlifts, Pull-ups, Rows\n**Leg Day:** Squats, Lunges, Leg Press\n\nAim for 3-4 sets of 8-12 reps. Rest 48 hours between muscle groups. Progressive overload is key! üí™`;
            }
            
            if (msg.includes('bench press')) {
                return `Bench Press Tips:\n\n1. Keep your feet flat on the ground\n2. Retract your shoulder blades\n3. Lower the bar to mid-chest\n4. Drive through your legs\n5. Keep your core tight\n\nStart with a weight you can control for 8-10 reps. Focus on form over weight! üèãÔ∏è`;
            }
            
            if (msg.includes('chest')) {
                return `Great chest exercises:\n\n1. **Bench Press** - Overall mass\n2. **Incline Press** - Upper chest\n3. **Dips** - Lower chest\n4. **Flyes** - Chest stretch\n5. **Push-ups** - Endurance\n\nMix these up for complete chest development! üí™`;
            }
            
            if (msg.includes('overtraining') || msg.includes('recovery')) {
                return `Signs of overtraining:\n- Persistent fatigue\n- Decreased performance\n- Mood changes\n- Sleep issues\n\n**Recovery tips:**\n- Get 7-9 hours sleep\n- Rest 48h between muscle groups\n- Eat enough protein (1.6-2.2g per kg)\n- Stay hydrated\n- Take rest days seriously!\n\nListen to your body! üõå`;
            }
            
            return `Great question! Here's my advice:\n\nFocus on progressive overload - gradually increase weight, reps, or sets over time. Consistency is more important than intensity. Make sure you're eating enough protein (1.6-2.2g per kg bodyweight) and getting adequate rest.\n\nBased on your ${stats?.totalSessions || 0} sessions, you're making progress! Keep pushing! üí™`;
        }
        
        // Add message to chat
        function addMessage(text, type) {
            const chat = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `
                <div class="message-label">${type === 'user' ? t('you') : t('aiCoach')}</div>
                <div>${text.replace(/\n/g, '<br>')}</div>
            `;
            chat.appendChild(message);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // Quick question
        function askQuestion(question) {
            document.getElementById('userInput').value = question;
            sendMessage();
        }
        
        // Enter to send
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Language translations
        const translations = {
            en: {
                q1: 'Create a training plan for me',
                q2: 'How to improve my bench press?',
                q3: 'What exercises for chest?',
                q4: 'Am I overtraining?',
                you: 'You',
                aiCoach: 'AI Coach',
                thinking: 'Thinking...',
                send: 'Send',
                noData: 'No training data yet. Start tracking your workouts!',
                totalSessions: 'Total Sessions',
                totalWeight: 'Total Weight Lifted',
                uniqueExercises: 'Unique Exercises',
                lastWorkout: 'Last Workout',
                never: 'Never'
            },
            pl: {
                q1: 'Stw√≥rz dla mnie plan treningowy',
                q2: 'Jak poprawiƒá m√≥j wyciskanie sztangi?',
                q3: 'Jakie ƒáwiczenia na klatkƒô piersiowƒÖ?',
                q4: 'Czy przetrenowujƒô?',
                you: 'Ty',
                aiCoach: 'Trener AI',
                thinking: 'My≈õlƒô...',
                send: 'Wy≈õlij',
                noData: 'Brak danych treningowych. Zacznij ≈õledziƒá swoje treningi!',
                totalSessions: '≈ÅƒÖczna liczba sesji',
                totalWeight: 'Ca≈Çkowity podniesiony ciƒô≈ºar',
                uniqueExercises: 'Unikalne ƒáwiczenia',
                lastWorkout: 'Ostatni trening',
                never: 'Nigdy'
            }
        };
        
        let currentLang = localStorage.getItem('language') || 'en';
        
        // Switch language
        window.switchLanguage = function(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            // Update all elements with data-en and data-pl attributes
            document.querySelectorAll('[data-en]').forEach(el => {
                if (el.tagName === 'TEXTAREA') {
                    el.placeholder = el.getAttribute(`data-${lang}-placeholder`);
                } else {
                    el.textContent = el.getAttribute(`data-${lang}`);
                }
            });
            
            // Update button styles
            document.getElementById('langEN').style.opacity = lang === 'en' ? '1' : '0.5';
            document.getElementById('langPL').style.opacity = lang === 'pl' ? '1' : '0.5';
            
            // Reload stats
            loadUserStats();
        };
        
        // Get translation
        function t(key) {
            return translations[currentLang][key] || translations.en[key];
        }
        
        // Reset API key
        function resetApiKey() {
            const confirmMsg = currentLang === 'pl' ? 'Czy chcesz zmieniƒá sw√≥j klucz API Groq?' : 'Do you want to change your Groq API key?';
            const promptMsg = currentLang === 'pl' ? 'Wprowad≈∫ nowy klucz API Groq:\n\nOtrzymaj go ZA DARMO z: https://console.groq.com/keys' : 'Enter your new Groq API key:\n\nGet it FREE from: https://console.groq.com/keys';
            const successMsg = currentLang === 'pl' ? 'Klucz API zaktualizowany pomy≈õlnie!' : 'API key updated successfully!';
            
            if (confirm(confirmMsg)) {
                localStorage.removeItem('groqApiKey');
                const newKey = prompt(promptMsg);
                if (newKey) {
                    localStorage.setItem('groqApiKey', newKey);
                    alert(successMsg);
                }
            }
        }
        
        // Initialize language on load
        setTimeout(() => {
            switchLanguage(currentLang);
        }, 100);
        
        // Load stats on page load
        loadUserStats();
    </script>
</body>
</html>
